<div id="palette-builder" style="text-align:center;">
Â  <h3>Customize Your Palette </h3>

Â  <div style="position:relative; display:inline-block; margin-top:10px; margin-bottom: 450px;"> 
Â  Â  <img id="palette-base"
Â  Â  Â  Â  Â src="https://cdn.shopify.com/s/files/1/0742/8069/8157/files/palette_base.png?v=1762159897"
Â  Â  Â  Â  Â style="width:400px; border-radius:10px; 
               display:block; 
               height: auto; /* Let height adjust to new width */
               max-width: 100%; 
               z-index: 1;"> 
Â  Â  <div id="pan-container" style="z-index: 2;"></div> 
Â  </div>

Â  Â  <div style="text-align:center; margin-top: 15px;">
Â  Â  <h3 id="palette-price" style="margin-bottom: 10px;">ğŸ’µ Total: â‚±0</h3>
Â  Â  <button id="add-to-cart" style="background:#000; color:white; border:none; padding:10px 20px; border-radius:5px; cursor:pointer; font-size:16px; font-weight:bold;">Add to Cart</button>
Â  </div>

Â  Â  <div id="shade-popup" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%);
Â  Â  Â  background:white; border-radius:10px; padding:15px; box-shadow:0 0 15px rgba(0,0,0,0.3); z-index:999;">
Â  Â  <h4 style="margin-bottom:10px;">Select a Shade</h4>
Â  Â  <div id="shade-list" style="display:flex; flex-wrap:wrap; gap:10px; justify-content:center;"></div>
Â  Â  <button onclick="closePopup()" style="margin-top:10px; background:#333; color:white; border:none; padding:6px 12px; border-radius:5px; cursor:pointer;">Close</button>
Â  </div>
</div>

<script>
const shadeImages = [
Â  { name: "Milk Bread", url: "https://cdn.shopify.com/s/files/1/0742/8069/8157/files/Milk_bread_Airset_matte_powder.png?v=1733124576", price: 120 },
Â  { name: "Shortcake", url: "https://cdn.shopify.com/s/files/1/0742/8069/8157/files/Shortcake_Airset_matte_powder.png?v=1733124577", price: 120 },
Â  { name: "Pretzel", url: "https://cdn.shopify.com/s/files/1/0742/8069/8157/files/Pretzel_Airset_matte_powder.png?v=1733124577", price: 120 },
Â  { name: "Tart", url: "https://cdn.shopify.com/s/files/1/0742/8069/8157/files/Tart_Airset_matte_powder.png?v=1733124577", price: 120 },
Â  { name: "Major Glow", url: "https://cdn.shopify.com/s/files/1/0742/8069/8157/files/major_glow_pressed.png?v=1733279560", price: 150 }
];

const container = document.getElementById("pan-container");
const popup = document.getElementById("shade-popup");
const shadeList = document.getElementById("shade-list");
const priceDisplay = document.getElementById("palette-price");
const addToCartBtn = document.getElementById("add-to-cart");

let selectedPan = null;
let selectedShades = {}; 

// consistent image style
function applyPanImageStyle(img) {
Â  img.style.width = "100%";
Â  img.style.height = "100%";
Â  img.style.objectFit = "cover"; 
Â  img.style.background = "#f6f6f6";
Â  img.style.cursor = "pointer";
Â  img.style.display = "block";
Â  img.style.borderRadius = "4px"; 
}

// â­ OPTIMIZED POSITIONING FOR THE METAL PALETTE BASE (width: 400px)
container.style.position = "absolute";
container.style.top = "115px";      // Move down to align with the pan area
container.style.left = "45px";     // Move right to align with the pan area
container.style.width = "310px";   // Width of the pan area
container.style.height = "295px";  // Height of the pan area
container.style.display = "grid";
container.style.gridTemplateColumns = "repeat(2, 1fr)";
container.style.gap = "8px"; // Reduced gap slightly to fit the metal grid

// create 4 main slots
for (let i = 0; i < 4; i++) {
Â  const slot = document.createElement("div");
Â  slot.classList.add("pan-slot");
Â  slot.id = `pan-${i + 1}`;
Â  slot.dataset.mode = "big";
Â  slot.style.position = "relative";
Â  slot.style.width = "100%"; 
Â  slot.style.height = "100%"; 
Â  slot.style.border = "none";
Â  slot.style.borderRadius = "8px"; 
Â  slot.style.background = "transparent";

Â  // big pan
Â  const bigPan = document.createElement("img");
Â  applyPanImageStyle(bigPan);
Â  bigPan.dataset.id = slot.id; 
Â  bigPan.onclick = (e) => {
Â  Â  e.stopPropagation();
Â  Â  selectedPan = bigPan;
Â  Â  openPopup();
Â  };
Â  slot.appendChild(bigPan);

Â  // 4 small pans (seamless fit fix)
Â  const smallGrid = document.createElement("div");
Â  smallGrid.style.position = "absolute";
Â  smallGrid.style.top = "0";
Â  smallGrid.style.left = "0";
Â  smallGrid.style.width = "100%";
Â  smallGrid.style.height = "100%";
Â  smallGrid.style.display = "none";
Â  smallGrid.style.gridTemplateColumns = "repeat(2, 1fr)";
Â  smallGrid.style.gap = "0"; 
Â  smallGrid.style.padding = "0";

Â  for (let j = 0; j < 4; j++) {
Â  Â  const mini = document.createElement("img");
Â  Â  applyPanImageStyle(mini);
Â  Â  mini.style.borderRadius = "4px"; 
Â  Â  mini.dataset.id = `small-${i + 1}-${j + 1}`; 
Â  Â  mini.onclick = (e) => {
Â  Â  Â  e.stopPropagation();
Â  Â  Â  selectedPan = mini;
Â  Â  Â  openPopup();
Â  Â  };
Â  Â  smallGrid.appendChild(mini);
Â  }
Â  slot.appendChild(smallGrid);

Â  // 2 vertical pans (seamless fit fix)
Â  const verticalGrid = document.createElement("div");
Â  verticalGrid.style.position = "absolute";
Â  verticalGrid.style.top = "0";
Â  verticalGrid.style.left = "0";
Â  verticalGrid.style.width = "100%";
Â  verticalGrid.style.height = "100%";
Â  verticalGrid.style.display = "none";
Â  verticalGrid.style.gridTemplateRows = "repeat(2, 1fr)";
Â  verticalGrid.style.gap = "0"; 
Â  verticalGrid.style.padding = "0";

Â  for (let k = 0; k < 2; k++) {
Â  Â  const vert = document.createElement("img");
Â  Â  applyPanImageStyle(vert);
Â  Â  vert.style.borderRadius = "4px"; 
Â  Â  vert.dataset.id = `vertical-${i + 1}-${k + 1}`; 
Â  Â  vert.onclick = (e) => {
Â  Â  Â  e.stopPropagation();
Â  Â  Â  selectedPan = vert;
Â  Â  Â  openPopup();
Â  Â  };
Â  Â  verticalGrid.appendChild(vert);
Â  }
Â  slot.appendChild(verticalGrid);

Â  // ğŸ”„ resize button
Â  const resizeBtn = document.createElement("button");
Â  resizeBtn.innerHTML = "ğŸ”„";
Â  resizeBtn.style.position = "absolute";
Â  resizeBtn.style.bottom = "5px";
Â  resizeBtn.style.right = "5px";
Â  resizeBtn.style.border = "none";
Â  resizeBtn.style.background = "white";
Â  resizeBtn.style.borderRadius = "5px";
Â  resizeBtn.style.padding = "4px";
Â  resizeBtn.style.cursor = "pointer";
Â  resizeBtn.style.fontSize = "16px";
Â  resizeBtn.onclick = (e) => {
Â  Â  e.stopPropagation();
Â  Â  togglePanMode(slot, bigPan, smallGrid, verticalGrid);
Â  Â  clearShadesInSlot(slot.id); 
Â  };
Â  slot.appendChild(resizeBtn);

Â  container.appendChild(slot);
}

// Function to clear shades from the selectedShades object when mode is changed
function clearShadesInSlot(slotId) {
    const keysToRemove = Object.keys(selectedShades).filter(key => 
        key === slotId || key.startsWith(`small-${slotId.split('-')[1]}-`) || key.startsWith(`vertical-${slotId.split('-')[1]}-`)
    );

    keysToRemove.forEach(key => {
        delete selectedShades[key];
    });

    updatePrice();
}

// ğŸŒ€ Mode Toggle (visual)
function togglePanMode(slot, big, small, vertical) {
Â  if (slot.dataset.mode === "big") {
Â  Â  slot.dataset.mode = "small";
Â  Â  big.style.display = "none";
Â  Â  small.style.display = "grid";
Â  Â  vertical.style.display = "none";
Â  } else if (slot.dataset.mode === "small") {
Â  Â  slot.dataset.mode = "vertical";
Â  Â  big.style.display = "none";
Â  Â  small.style.display = "none";
Â  Â  vertical.style.display = "grid";
Â  } else {
Â  Â  slot.dataset.mode = "big";
Â  Â  big.style.display = "block";
Â  Â  small.style.display = "none";
Â  Â  vertical.style.display = "none";
Â  }
}

// ğŸ¨ Popup Shade Picker
function openPopup() {
Â  if (!selectedPan) return;

Â  shadeList.innerHTML = "";
Â  shadeImages.forEach(shade => {
Â  Â  const img = document.createElement("img");
Â  Â  img.src = shade.url;
Â  Â  img.alt = shade.name;
Â  Â  img.style.width = "60px";
Â  Â  img.style.height = "60px";
Â  Â  img.style.borderRadius = "8px";
Â  Â  img.style.cursor = "pointer";
Â  Â  img.style.border = "1px solid #ddd";
Â  Â  img.title = `${shade.name} (â‚±${shade.price})`;
Â  Â  img.onclick = () => {
Â  Â  Â  selectedPan.src = shade.url;
Â  Â  Â  const panKey = selectedPan.dataset.id; 
Â  Â  Â  selectedShades[panKey] = shade;
Â  Â  Â  closePopup();
Â  Â  Â  updatePrice();
Â  Â  };
Â  Â  shadeList.appendChild(img);
Â  });
Â  popup.style.display = "block";
}
function closePopup() { popup.style.display = "none"; }

// ğŸ’° Update Total Price
function updatePrice() {
Â  const total = Object.values(selectedShades).reduce((sum, s) => sum + s.price, 0);
Â  priceDisplay.textContent = `ğŸ’µ Total: â‚±${total.toLocaleString()}`;
}

// ğŸ›’ Add to Cart
addToCartBtn.addEventListener("click", async () => {
Â  const totalPrice = Object.values(selectedShades).reduce((sum, s) => sum + s.price, 0);
Â  if (Object.keys(selectedShades).length === 0) {
Â  Â  alert("Please select at least one shade before adding to cart.");
Â  Â  return;
Â  }

Â  const properties = {};
Â  
Â  Object.keys(selectedShades).forEach((panKey, index) => {
Â  Â  const s = selectedShades[panKey];
Â  Â  let propertyName = panKey.replace('pan', 'Big Pan').replace('small', 'Small Pan').replace('vertical', 'Vertical Pan');
Â  Â  properties[`${propertyName}`] = s.name;
Â  });
Â  
Â  properties["_Total_Price"] = `â‚±${totalPrice.toLocaleString()}`;

Â  try {
Â  Â  const response = await fetch("/cart/add.js", {
Â  Â  Â  method: "POST",
Â  Â  Â  headers: { "Content-Type": "application/json" },
Â  Â  Â  body: JSON.stringify({
Â  Â  Â  Â  id: {{ product.variants.first.id }},
Â  Â  Â  Â  quantity: 1,
Â  Â  Â  Â  properties: properties
Â  Â  Â  })
Â  Â  });
Â  Â  if (response.ok) {
Â  Â  Â  alert("ğŸ‰ Palette added to your cart!");
Â  Â  Â  window.location.href = '/cart'; 
Â  Â  } else {
Â  Â  Â  const errorData = await response.json();
Â  Â  Â  alert(`Something went wrong adding to cart: ${errorData.description || 'Unknown error.'}`);
Â  Â  }
Â  } catch (err) {
Â  Â  console.error("Add to cart error:", err);
Â  Â  alert("Error adding to cart.");
Â  }
});

// Initial price display
updatePrice();
</script>